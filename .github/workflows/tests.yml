name: Chaguo Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  # Unit Tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Install dependencies
      run: |
        npm ci
        cd desktop-app && npm ci

    - name: Run ESLint
      run: |
        npm run lint
        cd desktop-app && npm run lint

    - name: Run TypeScript type checking
      run: |
        npx tsc --noEmit --project jsconfig.json
        cd desktop-app && npx tsc --noEmit --project jsconfig.json || true

    - name: Run unit tests
      run: |
        npm test
        cd desktop-app && npm test -- --coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: matrix.node-version == '18.x'
      with:
        files: ./desktop-app/coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  # Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      # Start a test VPN server
      vpn-test-server:
        image: v2fly/v2fly-core:latest
        options: >-
          --health-cmd="curl -f http://localhost:8080/ping || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - "10086:10086"
        
      # Start Shadowsocks test server
      ss-test-server:
        image: shadowsocks/shadowsocks-libev:latest
        options: >-
          --health-cmd="nc -z localhost 8388 || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - "18388:8388"
        env:
          SERVER_ADDR: 0.0.0.0
          SERVER_PORT: 8388
          PASSWORD: testpassword
          METHOD: aes-256-gcm

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        cd desktop-app && npm ci

    - name: Wait for test servers
      run: |
        sleep 10
        docker ps -a
        echo "Test servers should be ready"

    - name: Run integration tests
      run: |
        npm run test:integration
      env:
        VPN_TEST_HOST: localhost
        VPN_TEST_PORT: 10086
        SS_TEST_HOST: localhost
        SS_TEST_PORT: 18388
        SS_TEST_PASSWORD: testpassword
        SS_TEST_METHOD: aes-256-gcm

    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: integration-test-results
        path: |
          test-results/
          coverage/
        retention-days: 7

  # Security Tests
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run npm audit
      run: |
        npm audit --audit-level=moderate
        cd desktop-app && npm audit --audit-level=moderate

    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      if: env.SNYK_TOKEN
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@v1
      env:
        # Increase memory for large projects
        JAVA_OPTS: '-Xmx4g'
      with:
        project: 'chaguo-tanzania'
        path: '.'
        format: 'HTML'
        out: './reports'

    - name: Upload security reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          reports/
        retention-days: 30

  # E2E Tests
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    strategy:
      matrix:
        # Test on multiple Electron versions
        electron-version: [25, 26, 27]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: desktop-app/package-lock.json

    - name: Install dependencies
      working-directory: desktop-app
      run: npm ci

    - name: Install Playwright browsers
      working-directory: desktop-app
      run: npx playwright install --with-deps chromium

    - name: Run E2E tests
      working-directory: desktop-app
      run: npm run test:e2e
      env:
        ELECTRON_VERSION: ${{ matrix.electron-version }}
        TEST_ENV: github
        CI: true

    - name: Upload E2E test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: e2e-test-results-${{ matrix.electron-version }}
        path: |
          desktop-app/test-results/
          desktop-app/playwright-report/
        retention-days: 7

    - name: Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: playwright-report-${{ matrix.electron-version }}
        path: desktop-app/playwright-report/
        retention-days: 7

  # Build Tests
  build-tests:
    name: Build Tests
    runs-on: ${{ matrix.os }}
    needs: [unit-tests, security-tests]
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [18.x]
        include:
          - os: ubuntu-latest
            artifact_name: linux
          - os: macos-latest
            artifact_name: macos
          - os: windows-latest
            artifact_name: windows

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: desktop-app/package-lock.json

    - name: Install dependencies
      working-directory: desktop-app
      run: npm ci

    - name: Build Electron app
      working-directory: desktop-app
      run: npm run build
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CI: true

    - name: Verify build output
      working-directory: desktop-app
      run: |
        ls -la dist/
        if [ -f dist/*.exe ] || [ -f dist/*.dmg ] || [ -f dist/*.AppImage ] || [ -f dist/*.deb ] || [ -f dist/*.rpm ]; then
          echo "Build artifacts found"
        else
          echo "No build artifacts found"
          exit 1
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: chaguo-build-${{ matrix.artifact_name }}
        path: |
          desktop-app/dist/*.exe
          desktop-app/dist/*.dmg
          desktop-app/dist/*.AppImage
          desktop-app/dist/*.deb
          desktop-app/dist/*.rpm
          desktop-app/dist/*.zip
        if-no-files-found: warn
        retention-days: 7

  # Performance Tests
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, build-tests]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Lighthouse performance tests
      run: |
        npm install -g lighthouse
        lighthouse https://cephasgm.github.io/chaguo-tanzania/ --output json --output html --output-path ./lighthouse-report
        lighthouse https://cephasgm.github.io/chaguo-tanzania/desktop-app/ --output json --output html --output-path ./desktop-lighthouse-report

    - name: Run WebPageTest
      if: env.WEBPAGETEST_API_KEY
      run: |
        npm install webpagetest -g
        webpagetest test https://cephasgm.github.io/chaguo-tanzania/ --key $WEBPAGETEST_API_KEY --location "Dulles:Chrome" --poll 10 --timeout 300 --output json --output-dir ./webpagetest-results
      env:
        WEBPAGETEST_API_KEY: ${{ secrets.WEBPAGETEST_API_KEY }}

    - name: Upload performance reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: performance-reports
        path: |
          lighthouse-report.*
          desktop-lighthouse-report.*
          webpagetest-results/
        retention-days: 30

  # Network Tests
  network-tests:
    name: Network Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install network testing tools
      run: |
        sudo apt-get update
        sudo apt-get install -y curl dnsutils netcat-openbsd iputils-ping mtr

    - name: Test DNS resolution
      run: |
        ./scripts/test-from-tz.sh --dns-only
        cat dns-test-results.txt

    - name: Test network connectivity
      run: |
        timeout 60 ./scripts/test-network-connectivity.sh || true

    - name: Test VPN protocols
      run: |
        python3 scripts/test-vpn-protocols.py --quick

    - name: Upload network test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: network-test-results
        path: |
          dns-test-results.txt
          connectivity-results.json
          vpn-protocol-tests.json
        retention-days: 7

  # Compliance Tests
  compliance-tests:
    name: Compliance Tests
    runs-on: ubuntu-latest
    needs: [security-tests, unit-tests]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Run license compliance check
      run: |
        npx license-checker --summary --onlyAllow "MIT;ISC;BSD-2-Clause;BSD-3-Clause;Apache-2.0;CC0-1.0"
        cd desktop-app && npx license-checker --summary --onlyAllow "MIT;ISC;BSD-2-Clause;BSD-3-Clause;Apache-2.0;CC0-1.0"

    - name: Run accessibility audit
      run: |
        npm install -g pa11y
        pa11y https://cephasgm.github.io/chaguo-tanzania/ --reporter json > accessibility-report.json
        pa11y https://cephasgm.github.io/chaguo-tanzania/desktop-app/ --reporter json > desktop-accessibility-report.json

    - name: Generate SBOM
      run: |
        npx @cyclonedx/cyclonedx-npm --output-file bom.json
        cd desktop-app && npx @cyclonedx/cyclonedx-npm --output-file bom-desktop.json

    - name: Upload compliance reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: compliance-reports
        path: |
          accessibility-report.json
          desktop-accessibility-report.json
          bom.json
          bom-desktop.json
        retention-days: 30

  # Deploy Tests
  deploy-tests:
    name: Deploy Tests
    runs-on: ubuntu-latest
    needs: [build-tests, performance-tests, compliance-tests]
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Test deployment scripts
      run: |
        chmod +x scripts/server-setup.sh
        # Run in dry-run mode
        ./scripts/server-setup.sh --dry-run
        chmod +x scripts/deploy-infra.sh
        ./scripts/deploy-infra.sh --validate-only

    - name: Test configuration generation
      run: |
        node scripts/generate-configs.js --test
        node scripts/validate-configs.js

    - name: Verify deployment assets
      run: |
        ls -la
        test -f index.html || exit 1
        test -f manifest.json || exit 1
        test -f sw.js || exit 1
        test -d icons || exit 1
        echo "All deployment assets present"

    - name: Upload deployment test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: deploy-test-results
        path: |
          config-test-results.json
          deploy-validation.log
        retention-days: 7

  # Final Quality Gate
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [
      unit-tests,
      integration-tests,
      security-tests,
      e2e-tests,
      build-tests,
      performance-tests,
      network-tests,
      compliance-tests,
      deploy-tests
    ]
    
    steps:
    - name: Check all tests passed
      run: |
        echo "All required tests completed successfully!"
        echo ""
        echo "‚úÖ Unit Tests: ${{ needs.unit-tests.result }}"
        echo "‚úÖ Integration Tests: ${{ needs.integration-tests.result }}"
        echo "‚úÖ Security Tests: ${{ needs.security-tests.result }}"
        echo "‚úÖ E2E Tests: ${{ needs.e2e-tests.result }}"
        echo "‚úÖ Build Tests: ${{ needs.build-tests.result }}"
        echo "‚úÖ Performance Tests: ${{ needs.performance-tests.result }}"
        echo "‚úÖ Network Tests: ${{ needs.network-tests.result }}"
        echo "‚úÖ Compliance Tests: ${{ needs.compliance-tests.result }}"
        echo "‚úÖ Deploy Tests: ${{ needs.deploy-tests.result }}"
        echo ""
        
        # Check if any tests failed
        if [[ "${{ needs.unit-tests.result }}" == "failure" ]] || \
           [[ "${{ needs.integration-tests.result }}" == "failure" ]] || \
           [[ "${{ needs.security-tests.result }}" == "failure" ]] || \
           [[ "${{ needs.e2e-tests.result }}" == "failure" ]]; then
          echo "‚ùå Quality gate failed: Critical tests failed"
          exit 1
        fi
        
        if [[ "${{ needs.build-tests.result }}" == "failure" ]] || \
           [[ "${{ needs.performance-tests.result }}" == "failure" ]]; then
          echo "‚ö†Ô∏è Quality gate warning: Non-critical tests failed"
          # Don't fail for warnings, just notify
        fi
        
        echo "üéâ All quality checks passed!"
        
    - name: Generate test summary
      if: always()
      uses: test-summary/action@v2
      with:
        paths: "**/*test-results*.xml"

    - name: Comment on PR with test results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const results = {
            unit: '${{ needs.unit-tests.result }}',
            integration: '${{ needs.integration-tests.result }}',
            security: '${{ needs.security-tests.result }}',
            e2e: '${{ needs.e2e-tests.result }}',
            build: '${{ needs.build-tests.result }}',
            performance: '${{ needs.performance-tests.result }}',
            compliance: '${{ needs.compliance-tests.result }}'
          };
          
          let comment = `## üß™ Test Results for PR #${{ github.event.pull_request.number }}\n\n`;
          
          Object.entries(results).forEach(([test, result]) => {
            const emoji = result === 'success' ? '‚úÖ' : result === 'failure' ? '‚ùå' : '‚ö†Ô∏è';
            comment += `${emoji} **${test.charAt(0).toUpperCase() + test.slice(1)} Tests**: ${result}\n`;
          });
          
          comment += `\n**Overall Status**: ${
            results.unit === 'success' && 
            results.integration === 'success' && 
            results.security === 'success' ? '‚úÖ PASSED' : '‚ùå FAILED'
          }`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
